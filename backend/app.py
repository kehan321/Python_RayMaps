from flask import Flask, request, jsonify
import numpy as np

app = Flask(__name__)

@app.route('/water_attenuation', methods=['GET'])
def water_attenuation():
    try:
        f = float(request.args.get('f'))
        p = float(request.args.get('p'))
        T = float(request.args.get('T'))
        
        # Constants
        watvaptab = np.array([
            [22.235080, 0.1130, 2.143, 28.11, 0.69, 4.800, 1.00],
            [67.803960, 0.0012, 8.735, 28.58, 0.69, 4.930, 0.82],
            [119.995940, 0.0008, 8.356, 29.48, 0.70, 4.780, 0.79],
            [183.310091, 2.4200, 0.668, 30.50, 0.64, 5.300, 0.85],
            [321.225644, 0.0483, 6.181, 23.03, 0.67, 4.690, 0.54],
            [325.152919, 1.4990, 1.540, 27.83, 0.68, 4.850, 0.74],
            [336.222601, 0.0011, 9.829, 26.93, 0.69, 4.740, 0.61],
            [380.197372, 11.5200, 1.048, 28.73, 0.54, 5.380, 0.89],
            [390.134508, 0.0046, 7.350, 21.52, 0.63, 4.810, 0.55],
            [437.346667, 0.0650, 5.050, 18.45, 0.60, 4.230, 0.48],
            [439.150812, 0.9218, 3.596, 21.00, 0.63, 4.290, 0.52],
            [443.018295, 0.1976, 5.050, 18.60, 0.60, 4.230, 0.50],
            [448.001075, 10.3200, 1.405, 26.32, 0.66, 4.840, 0.67],
            [470.888947, 0.3297, 3.599, 21.52, 0.66, 4.570, 0.65],
            [474.689127, 1.2620, 2.381, 23.55, 0.65, 4.650, 0.64],
            [488.491133, 0.2520, 2.853, 26.02, 0.69, 5.040, 0.72],
            [503.568532, 0.0390, 6.733, 16.12, 0.61, 3.980, 0.43],
            [504.482692, 0.0130, 6.733, 16.12, 0.61, 4.010, 0.45],
            [547.676440, 9.7010, 0.114, 26.00, 0.70, 4.500, 1.00],
            [552.020960, 14.7700, 0.114, 26.00, 0.70, 4.500, 1.00],
            [556.936002, 487.4000, 0.159, 32.10, 0.69, 4.110, 1.00],
            [620.700807, 5.0120, 2.200, 24.38, 0.71, 4.680, 0.68],
            [645.866155, 0.0713, 8.580, 18.00, 0.60, 4.000, 0.50],
            [658.005280, 0.3022, 7.820, 32.10, 0.69, 4.140, 1.00],
            [752.033227, 239.6000, 0.396, 30.60, 0.68, 4.090, 0.84],
            [841.053973, 0.0140, 8.180, 15.90, 0.33, 5.760, 0.45],
            [859.962313, 0.1472, 7.989, 30.60, 0.68, 4.090, 0.84],
            [899.306675, 0.0605, 7.917, 29.85, 0.68, 4.530, 0.90],
            [902.616173, 0.0426, 8.432, 28.65, 0.70, 5.100, 0.95],
            [906.207325, 0.1876, 5.111, 24.08, 0.70, 4.700, 0.53],
            [916.171582, 8.3400, 1.442, 26.70, 0.70, 4.780, 0.78],
            [923.118427, 0.0869, 10.220, 29.00, 0.70, 5.000, 0.80],
            [970.315022, 8.9720, 1.920, 25.50, 0.64, 4.940, 0.67],
            [987.926764, 132.1000, 0.258, 29.85, 0.68, 4.550, 0.90],
            [1780.000000, 22300.0000, 0.952, 176.20, 0.50, 30.500, 5.00]
        ])
        fi = watvaptab[:, 0]
        b1 = watvaptab[:, 1]
        b2 = watvaptab[:, 2]
        b3 = watvaptab[:, 3]
        b4 = watvaptab[:, 4]
        b5 = watvaptab[:, 5]
        b6 = watvaptab[:, 6]
        vd1 = 7.5
        e = (vd1 * T) / 216.7
        theta = 300 / T
        pe = p + e
        Si_vapor = b1 * 10 ** -1 * e * (theta ** 3.5) * np.exp(b2 * (1 - theta))  # Vapor

        delta_f = b3 * 10 ** -4 * (pe * (theta ** b4) + b5 * e * (theta ** b6))  # Vapor

        delta_f = 0.535 * delta_f + np.sqrt(0.217 * (delta_f ** 2) + (2.1316 * 10 ** -12 * fi ** 2) / theta)  # Vapor

        delta = 0

        Fi_vapor = (f / fi) * (
                (delta_f - delta * (fi - f)) / ((fi - f) ** 2 + delta_f ** 2) + (delta_f - delta * (fi + f)) / (
                (fi + f) ** 2 + delta_f ** 2))

        Ni_vapor = np.sum(Si_vapor * Fi_vapor)

        Gw = (Ni_vapor) * 0.1820 * 30
        return jsonify({'attenuation': Gw})

    except Exception as e:
        return jsonify({'error': str(e)}), 400

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
